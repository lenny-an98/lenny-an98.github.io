<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Study 2</title>
</head>
<body>
  <div id="msg" style="font-family: Arial, sans-serif; padding: 40px;">
    Loading…
  </div>

  <script>
    // ===== 설정 =====
    const FORM_URL = {
      A: "https://docs.google.com/forms/d/e/1FAIpQLSc_c5qcndSnP9-CFOVhJFMIOk7Ju2pVOB9u4VwrGZJFInkNCQ/viewform?usp=pp_url&entry.2035357625=8f9a2c7e&entry.1637470054=1f9a2c7e1",
      B: "https://docs.google.com/forms/d/e/1FAIpQLSdW8yroFiAHq6ZVGBIykdM53rA4yKSc6TbiTYEroO3GZHk3WA/viewform?usp=pp_url&entry.786136671=8f9a2c7e&entry.1344347264=2f9a2c7e2",
      C: "https://docs.google.com/forms/d/e/1FAIpQLSfNnQxd4qECGz_8seJtK6jpiQoVHlj5aAiq2UgZvV1Ay0xyTg/viewform?usp=pp_url&entry.1524847293=8f9a2c7e&entry.527201780=3f9a2c7e3"
    };

    const CLOSED_URL = "https://lenny-an98.github.io/closed.html";

    // ✅ 서버가 배정 결정(완전판)
    const ASSIGN_URL = "https://us-central1-study2-balanced.cloudfunctions.net/assignCondition";

    // localStorage keys
    const LS_PID  = "study2_pid";
    const LS_COND = "study2_condition";

    function setMsg(t) { document.getElementById("msg").textContent = t; }

    function getOrCreatePid() {
      let pid = localStorage.getItem(LS_PID);
      if (!pid) {
        pid = "p_" + Math.random().toString(16).slice(2) + "_" + Date.now();
        localStorage.setItem(LS_PID, pid);
      }
      return pid;
    }

    function hardRedirect(url) {
      const u = url + (url.includes("?") ? "&" : "?") + "cb=" + Date.now();
      window.location.replace(u);
    }

    async function serverAssign(pid) {
      const resp = await fetch(ASSIGN_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pid }),
      });

      const text = await resp.text();
      if (!resp.ok) {
        throw new Error(`assign failed HTTP ${resp.status} body=${text}`);
      }

      let data;
      try { data = JSON.parse(text); } catch (e) {
        throw new Error(`assign response not JSON: ${text}`);
      }
      return data;
    }

    (async () => {
      try {
        setMsg("Assigning…");
        const pid = getOrCreatePid();

        const r = await serverAssign(pid);

        if (r.closed) {
          hardRedirect(CLOSED_URL);
          return;
        }

        const chosen = r.chosen;
        if (!FORM_URL[chosen]) {
          throw new Error("Invalid chosen condition from server: " + chosen);
        }

        // 편의상 저장(조건 노출은 없음)
        localStorage.setItem(LS_COND, chosen);

        hardRedirect(FORM_URL[chosen]);
      } catch (e) {
        console.error(e);
        setMsg("ERROR: " + (e && e.message ? e.message : e));
      }
    })();
  </script>
</body>
</html>
