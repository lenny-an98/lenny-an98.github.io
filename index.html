<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Study 2 - Random Assignment</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; }
    .box { border: 1px solid #ccc; border-radius: 12px; padding: 20px; max-width: 640px; }
    .cond { font-size: 40px; margin: 10px 0; }
    .note { color: #666; }
  </style>
</head>
<body>
  <div class="box">
    <h1>Study 2</h1>
    <div>Assigned condition:</div>
    <div id="cond" class="cond">...</div>
    <p class="note" id="idline"></p>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC4F6HeywZSGpPYCKxnKLbdyGoFSpz0V_A",
    authDomain: "study2-balanced.firebaseapp.com",
    projectId: "study2-balanced",
    storageBucket: "study2-balanced.firebasestorage.app",
    messagingSenderId: "54961171728",
    appId: "1:54961171728:web:b01672dbc59a47f0f1c995",
    measurementId: "G-10JWV2SR8L"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- Local persistence keys ---
  const LS_PID = "study2_pid";
  const LS_COND = "study2_condition";

  function getOrCreatePid() {
    let pid = localStorage.getItem(LS_PID);
    if (!pid) {
      pid = "p_" + Math.random().toString(16).slice(2) + "_" + Date.now();
      localStorage.setItem(LS_PID, pid);
    }
    return pid;
  }

  async function assignBalancedConditionOnce() {
    // 이미 조건이 있으면 재배정/재카운트 금지
    const existing = localStorage.getItem(LS_COND);
    if (existing) return { chosen: existing, fromCache: true };

    const ref = db.collection("counters").doc("assignment");

    const chosen = await db.runTransaction(async (tx) => {
      const snap = await tx.get(ref);
      if (!snap.exists) throw new Error("Missing Firestore doc: counters/assignment");

      const data = snap.data();
      const counts = {
        A: Number(data.A ?? 0),
        B: Number(data.B ?? 0),
        C: Number(data.C ?? 0),
      };

      const minCount = Math.min(counts.A, counts.B, counts.C);
      const candidates = Object.keys(counts).filter(k => counts[k] === minCount);
      const pick = candidates[Math.floor(Math.random() * candidates.length)];

      tx.update(ref, {
        [pick]: firebase.firestore.FieldValue.increment(1),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      });

      return pick;
    });

    localStorage.setItem(LS_COND, chosen);
    return { chosen, fromCache: false };
  }

  // --- Run on load ---
  const pid = getOrCreatePid();

  assignBalancedConditionOnce()
    .then(({ chosen, fromCache }) => {
      document.getElementById("cond").textContent = chosen;
      document.getElementById("idline").textContent =
        `Participant ID: ${pid} · ${fromCache ? "Revisit" : "New assignment"}`;
    })
    .catch((err) => {
      document.getElementById("cond").textContent = "ERROR";
      document.getElementById("idline").textContent = err.message;
      console.error(err);
    });

  </script>
</body>
</html>

