<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Study 2 - Random Assignment</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; }
    .box { border: 1px solid #ccc; border-radius: 12px; padding: 20px; max-width: 640px; }
    .cond { font-size: 40px; margin: 10px 0; }
    .note { color: #666; }
  </style>
</head>
<body>
  <div class="box">
    <h1>Study 2</h1>
    <div>Assigned condition:</div>
    <div id="cond" class="cond">...</div>
    <p class="note" id="idline"></p>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC4F6HeywZSGpPYCKxnKLbdyGoFSpz0V_A",
      authDomain: "study2-balanced.firebaseapp.com",
      projectId: "study2-balanced",
      storageBucket: "study2-balanced.firebasestorage.app",
      messagingSenderId: "54961171728",
      appId: "1:54961171728:web:b01672dbc59a47f0f1c995",
      measurementId: "G-10JWV2SR8L"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const MAX_PER_CONDITION = 25;

    const FORM_URL = {
      A: "https://forms.gle/9XCqASn6oiWoKwzw7",
      B: "https://forms.gle/aobLrgCog4Z6mPx2A",
      C: "https://forms.gle/5jwjiibiHsJZ8sCdA",
    };

    const CLOSED_URL = "https://lenny-an98.github.io/closed.html";

    const LS_PID = "study2_pid";
    const LS_COND = "study2_condition";

    function getOrCreatePid() {
      let pid = localStorage.getItem(LS_PID);
      if (!pid) {
        pid = "p_" + Math.random().toString(16).slice(2) + "_" + Date.now();
        localStorage.setItem(LS_PID, pid);
      }
      return pid;
    }

    async function assignBalancedConditionOnce() {
      const existing = localStorage.getItem(LS_COND);
      if (existing) return { chosen: existing, fromCache: true, closed: false };

      const ref = db.collection("counters").doc("assignment");

      const chosen = await db.runTransaction(async (tx) => {
        const snap = await tx.get(ref);
        if (!snap.exists) throw new Error("Missing Firestore doc: counters/assignment");

        const data = snap.data();
        const counts = {
          A: Number(data.A ?? 0),
          B: Number(data.B ?? 0),
          C: Number(data.C ?? 0),
        };

        // 1) 아직 정원(MAX) 안 찬 조건만 후보
        const open = Object.keys(counts).filter(k => counts[k] < MAX_PER_CONDITION);

        // 2) 전부 찼으면: 여기서 종료 (카운트 업데이트 절대 없음)
        if (open.length === 0) return "__CLOSED__";

        // 3) 열린 조건들 중에서 최소값을 가진 것들만 후보
        const minOpenCount = Math.min(...open.map(k => counts[k]));
        const candidates = open.filter(k => counts[k] === minOpenCount);
        const pick = candidates[Math.floor(Math.random() * candidates.length)];

        // 4) 여기서만 카운트 증가
        tx.update(ref, {
          [pick]: firebase.firestore.FieldValue.increment(1),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        return pick;
      });

      if (chosen === "__CLOSED__") {
        return { chosen, fromCache: false, closed: true };
      }

      localStorage.setItem(LS_COND, chosen);
      return { chosen, fromCache: false, closed: false };
    }

    // --- Run on load ---
    const pid = getOrCreatePid();

    assignBalancedConditionOnce()
      .then(({ chosen, fromCache, closed }) => {
        if (closed) {
          window.location.replace(CLOSED_URL);
          return;
        }

        document.getElementById("cond").textContent = chosen;
        document.getElementById("idline").textContent =
            `Participant ID: ${pid} · ${fromCache ? "Revisit" : "New assignment"} · Redirecting...`;

        setTimeout(() => {
            window.location.replace(FORM_URL[chosen]);
        }, 2000);

      })
      .catch((err) => {
        document.getElementById("cond").textContent = "ERROR";
        document.getElementById("idline").textContent = err.message;
        console.error(err);
      });
  </script>
</body>
</html>


