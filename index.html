<script>
  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyC4F6HeywZSGpPYCKxnKLbdyGoFSpz0V_A",
    authDomain: "study2-balanced.firebaseapp.com",
    projectId: "study2-balanced",
    storageBucket: "study2-balanced.firebasestorage.app",
    messagingSenderId: "54961171728",
    appId: "1:54961171728:web:b01672dbc59a47f0f1c995",
    measurementId: "G-10JWV2SR8L"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ===== 설정 =====
  const MAX_PER_CONDITION = 25;

  const FORM_URL = {
    A: "https://docs.google.com/forms/d/e/1FAIpQLSc_c5qcndSnP9-CFOVhJFMIOk7Ju2pVOB9u4VwrGZJFInkNCQ/viewform?usp=pp_url&entry.2035357625=8f9a2c7e&entry.1637470054=1f9a2c7e1",
    B: "https://docs.google.com/forms/d/e/1FAIpQLSdW8yroFiAHq6ZVGBIykdM53rA4yKSc6TbiTYEroO3GZHk3WA/viewform?usp=pp_url&entry.786136671=8f9a2c7e&entry.1344347264=2f9a2c7e2",
    C: "https://docs.google.com/forms/d/e/1FAIpQLSfNnQxd4qECGz_8seJtK6jpiQoVHlj5aAiq2UgZvV1Ay0xyTg/viewform?usp=pp_url&entry.1524847293=8f9a2c7e&entry.527201780=3f9a2c7e3"
  };

  const CLOSED_URL = "https://lenny-an98.github.io/closed.html";

  // 로컬 잠금
  const LS_PID = "study2_pid";
  const LS_COND = "study2_condition";

  function getOrCreatePid() {
    let pid = localStorage.getItem(LS_PID);
    if (!pid) {
      pid = "p_" + Math.random().toString(16).slice(2) + "_" + Date.now();
      localStorage.setItem(LS_PID, pid);
    }
    return pid;
  }

  async function getCompletedCounts() {
    const snap = await db.collection("completed").doc("counts").get();
    if (!snap.exists) throw new Error("Missing Firestore doc: completed/counts");

    const d = snap.data() || {};
    return {
      A: Number(d.A ?? 0),
      B: Number(d.B ?? 0),
      C: Number(d.C ?? 0)
    };
  }

  function pickBalancedOpen(counts) {
    const open = Object.keys(counts).filter(k => counts[k] < MAX_PER_CONDITION);
    if (open.length === 0) return "__CLOSED__";

    const min = Math.min(...open.map(k => counts[k]));
    const candidates = open.filter(k => counts[k] === min);
    return candidates[Math.floor(Math.random() * candidates.length)];
  }

  async function decideAndRedirect() {
    getOrCreatePid(); // 지금은 폼에 pid를 안 넣지만, 유지해도 무해함

    // 1) completed 기준으로 전체 마감 여부 판단
    const counts = await getCompletedCounts();
    const allFull = (counts.A >= MAX_PER_CONDITION) &&
                    (counts.B >= MAX_PER_CONDITION) &&
                    (counts.C >= MAX_PER_CONDITION);
    if (allFull) {
      window.location.replace(CLOSED_URL);
      return;
    }

    // 2) 재방문이면: 기존 조건으로 그대로 보냄 (중복 카운트는 Apps Script가 "동의함 제출"에서만 올림)
    const existing = localStorage.getItem(LS_COND);
    if (existing && FORM_URL[existing]) {
      window.location.replace(FORM_URL[existing]);
      return;
    }

    // 3) 신규면: completed 기준으로 “열린 조건 중 최소”에 배정
    const chosen = pickBalancedOpen(counts);
    if (chosen === "__CLOSED__") {
      window.location.replace(CLOSED_URL);
      return;
    }

    localStorage.setItem(LS_COND, chosen);
    window.location.replace(FORM_URL[chosen]);
  }

  decideAndRedirect().catch((err) => {
    // 디버그용(배포 후엔 숨겨도 됨)
    document.body.innerHTML = "<pre>ERROR: " + err.message + "</pre>";
    console.error(err);
  });
</script>



